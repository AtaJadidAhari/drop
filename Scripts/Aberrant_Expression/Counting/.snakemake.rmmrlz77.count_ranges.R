
######## Snakemake header ########
library(methods)
Snakemake <- setClass(
    "Snakemake",
    slots = c(
        input = "list",
        output = "list",
        params = "list",
        wildcards = "list",
        threads = "numeric",
        log = "list",
        resources = "list",
        config = "list",
        rule = "character"
    )
)
snakemake <- Snakemake(
    input = list('Scripts/Aberrant_Expression/Counting/count_ranges.R', '/s/project/genetic_diagnosis/processed_results/v29/txdb.db', '/s/project/genetic_diagnosis/processed_results/v19/txdb.db', "RScript" = 'Scripts/Aberrant_Expression/Counting/count_ranges.R', "gencode_txdb" = '/s/project/genetic_diagnosis/processed_results/v29/txdb.db', "gtex_txdb" = '/s/project/genetic_diagnosis/processed_results/v19/txdb.db'),
    output = list('/s/project/genetic_diagnosis/processed_results/v19/counts/exons_by_gene_op.Rds', '/s/project/genetic_diagnosis/processed_results/v29/counts/exons_by_gene_op.Rds', '/s/project/genetic_diagnosis/processed_results/v29_overlap/counts/exons_by_gene_op.Rds', "gencode_ov_op" = '/s/project/genetic_diagnosis/processed_results/v29_overlap/counts/exons_by_gene_op.Rds', "gencode_op" = '/s/project/genetic_diagnosis/processed_results/v29/counts/exons_by_gene_op.Rds', "gtex_op" = '/s/project/genetic_diagnosis/processed_results/v19/counts/exons_by_gene_op.Rds'),
    params = list(),
    wildcards = list(),
    threads = 1,
    log = list(),
    resources = list(),
    config = list("RAW_DATA" = '/s/project/mitoMultiOmics/raw_data/helmholtz', "htmlOutputPath" = 'Output/html', "PROC_RESULTS" = '/s/project/genetic_diagnosis/processed_results', "projectTitle" = 'Genetic diagnosis of Mendelian disorders', "SAMPLE_ANNOTATION" = '../sample_annotation/Data/sample_annotation.tsv', "ANNOTATIONS" = c('v29_overlap'), "fpkmCutoff" = 1, "VEP_VERSION" = 94, "SAMPLE_IDS" = c('100634R', '101401R', '101676R', '102384R', '102385R', '102386R', '102387R', '102388R', '102389R', '102390R', '102391R', '102392R', '102393R', '102630R', '102631R', '102632R', '102860R', '102864R', '102874R', '102875R', '102876R', '102949R', '102950R', '102951R', '102952R', '103027R', '103165R', '103166R', '103170R', '103171R', '103172R', '103173R', '103174R', '103175R', '103180R', '103182R', '103185R', '103190R', '103192R', '103198R', '103199R', '103200R', '103203R', '103207R', '103208R', '103209R', '103210R', '103213R', '103214R', '103216R', '103217R', '103219R', '103221R', '103223R', '103225R', '103229R', '103230R', '103231R', '103232R', '103234R', '103239R', '104355R', '104438R', '104981R', '104982R', '105251R', '105896R', '106244R', '110386R', '110390R', '110441R', '110442R', '110443R', '110444R', '110445R', '110446R', '110447R', '110448R', '110449R', '110450R', '110451R', '110452R', '110453R', '110454R', '110455R', '110456R', '110457R', '110458R', '110459R', '110462R', '110463R', '110464R', '110465R', '110466R', '110467R', '110468R', '110469R', '111689R', '111888R', '112172R', '112223R', '113015R', '113199R', '33254R', '33281R', 35834, 57415, 61695, 61982, '62336R_wrongID', 65937, 66623, 69245, 69248, 69456, 70038, 70041, 72748, 74123, 74172, 76619, 76620, 76621, 76622, 76623, 76624, 76625, 76626, 76627, 76628, 76629, 76630, 76631, 76632, 76633, 76635, 76636, 76637, 76638, '77158R', 90956, '97810R', '98521R', '99291R', '99292R', '99293R', '99294R', '99295R', '99296R', '99297R', '99298R', '99299R', '99300R', '99301R', '99302R', '99303R', '99304R', '99305R', '99306R', '99307R', '99590R', 'MUC0486', 'MUC0487', 'MUC0488', 'MUC0489', 'MUC0490', 'MUC0491', 'MUC1342', 'MUC1343', 'MUC1344', 'MUC1345', 'MUC1346', 'MUC1347', 'MUC1348', 'MUC1349', 'MUC1350', 'MUC1351', 'MUC1352', 'MUC1354', 'MUC1355', 'MUC1357', 'MUC1358', 'MUC1359', 'MUC1360', 'MUC1361', 'MUC1362', 'MUC1363', 'MUC1364', 'MUC1365', 'MUC1367', 'MUC1368', 'MUC1369', 'MUC1370', 'MUC1371', 'MUC1372', 'MUC1373', 'MUC1374', 'MUC1375', 'MUC1376', 'MUC1377', 'MUC1378', 'MUC1379', 'MUC1380', 'MUC1381', 'MUC1382', 'MUC1383', 'MUC1384', 'MUC1390', 'MUC1391', 'MUC1392', 'MUC1393', 'MUC1394', 'MUC1395', 'MUC1396', 'MUC1397', 'MUC1398', 'MUC1400', 'MUC1401', 'MUC1402', 'MUC1403', 'MUC1404', 'MUC1405', 'MUC1407', 'MUC1408', 'MUC1409', 'MUC1410', 'MUC1411', 'MUC1412', 'MUC1413', 'MUC1414', 'MUC1415', 'MUC1416', 'MUC1417', 'MUC1418', 'MUC1419', 'MUC1420', 'MUC1421', 'MUC1422', 'MUC1423', 'MUC1424', 'MUC1425', 'MUC1426', 'MUC1427', 'MUC1428', 'MUC1429', 'MUC1436', 'MUC1437', 'MUC2201', 'MUC2202', 'MUC2203', 'MUC2204', 'MUC2205', 'MUC2206', 'MUC2207', 'MUC2208', 'MUC2209', 'MUC2210', 'MUC2211', 'MUC2212', 'MUC2213', 'MUC2214', 'MUC2215', 'MUC2216', 'MUC2217', 'MUC2218', 'MUC2219', 'MUC2220', 'MUC2221', 'MUC2222', 'MUC2223', 'MUC2224', 'MUC2225', 'MUC2226', 'MUC2227', 'MUC2228', 'MUC2229', 'MUC2230', 'MUC2231', 'MUC2232', 'MUC3194', 'MUC3196', 'MUC3198', 'MUC3200', 'MUC3202'), "rnas" = c('100634R', '101401R', '101676R', '102384R', '102385R', '102386R', '102387R', '102388R', '102389R', '102390R', '102391R', '102392R', '102393R', '102860R', '102864R', '103174R', '102875R', '102876R', '102949R', '102950R', '102951R', '102952R', '103027R', '103165R', '103170R', '103172R', '103173R', '102874R', '103175R', '103180R', '103182R', '103190R', '103192R', '103198R', '103199R', '103200R', '103203R', '103207R', '103209R', '103210R', '103213R', '111664R', '111666R', '103214R', '111681R', '111682R', '103216R', '111668R', '111669R', '103217R', '103219R', '103221R', '111670R', '111671R', '103223R', '103225R', '103229R', '103231R', '103230R', '103232R', '103234R', '103239R', '104982R', '105251R', '105896R', '33254R', 'MUC1342', '33281R', 'MUC1343', '76631', 'MUC1344', 'MUC1345', '74172', 'MUC2202', '76634', '76623', 'MUC1347', '77158R', 'MUC1348', 'MUC1349', 'MUC2220', '57415', '70476', '76628', '70478', '76630', 'MUC1350', 'MUC1351', '76622', 'MUC1352', '76626', '76636', '61695', '76624', 'MUC1434', '61982', '70479', 'MUC1353', 'MUC1354', 'MUC1355', 'MUC1356', 'MUC1357', 'MUC1358', 'MUC1359', 'MUC1360', 'MUC1361', 'MUC1362', 'MUC2237', 'MUC1363', 'MUC1364', 'MUC2212', 'MUC1365', 'MUC1366', 'MUC1367', '76627', 'MUC1368', 'MUC1369', 'MUC1370', 'MUC1374', 'MUC1372', 'MUC1373', 'MUC1371', '76629', 'MUC2232', 'MUC1375', 'MUC1376', '76625', '76635', 'MUC1417', 'MUC2215', '72748', 'MUC1390', 'MUC1391', 'MUC1392', 'MUC2201', 'MUC1396', 'MUC1397', '76632', '76633', 'MUC1415', 'MUC1398', 'MUC1399', 'MUC1400', '76637', '76638', 'MUC1401', 'MUC1378', 'MUC1379', 'MUC1431', 'MUC1433', 'MUC1380', 'MUC1381', 'MUC1382', 'MUC1437', 'MUC1386', 'MUC1389', 'MUC2210', 'MUC1383', 'MUC1402', 'MUC1403', 'MUC1404', 'MUC1413', 'MUC1414', 'MUC1416', 'MUC1418', 'MUC1419', 'MUC1426', 'MUC1421', 'MUC1422', 'MUC1424', 'MUC1427', 'MUC1420', 'MUC1428', 'MUC1405', 'MUC1406', 'MUC1407', 'MUC1408', 'MUC1409', 'MUC2213', 'MUC0489', 'MUC0490', 'MUC0491', 'MUC0493', 'MUC0494', 'MUC0495', 'MUC0498', 'MUC0499', 'MUC2205', 'MUC1411', 'MUC1384', 'MUC1387', 'MUC1412', 'MUC2204', 'MUC2211', 'MUC2209', 'MUC2219', 'MUC2203', 'MUC2222', 'MUC1435', 'MUC2207', 'MUC2208', 'MUC2223', 'MUC2216', 'MUC2217', 'MUC2225', 'MUC2224', 'MUC2227', 'MUC2226', 'MUC2229', 'MUC2228', 'MUC2231', 'MUC2230', '97810R', '98521R', '99291R', '99292R', '99293R', '99294R', '99295R', '99296R', '99297R', '99298R', '99299R', '99300R', '99301R', '99302R', '99303R', '99304R', '99305R', '99306R', '99307R', 'MUC1425'), "webDir" = '/s/public_webshare/project/genetic_diagnosis', "vcfs" = c('92582', '89108', '85030', 'EXT_JAP_PT1298', 'EXT_JAP_PT1315', 'EXT_JAP_PT1320', 'EXT_JAP_PT1322', 'EXT_JAP_PT1342', 'EXT_JAP_PT1396', 'EXT_JAP_PT1433', 'EXT_JAP_PT1455', 'EXT_JAP_PT1475', 'EXT_JAP_PT322', 'EXT_JAP_PT1237', 'EXT_JAP_PT1265', 'EXT_JAP_PT1278', 'EXT_JAP_PT1283', 'EXT_JAP_PT1297', '55567', '55563', '75148', '55570', 'EXT_JAP_PT1173', 'EXT_JAP_PT008', 'EXT_JAP_PT162', 'EXT_JAP_PT183', 'EXT_JAP_PT201', 'EXT_JAP_PT284', 'EXT_JAP_PT290', 'EXT_JAP_PT472', 'EXT_JAP_PT487', 'EXT_JAP_PT631', 'EXT_JAP_PT639', 'EXT_JAP_PT713', 'EXT_JAP_PT722', 'EXT_JAP_PT723', 'EXT_JAP_PT766', 'EXT_JAP_PT875', 'EXT_JAP_PT947', 'EXT_JAP_PT966', 'EXT_JAP_PT984', 'EXT_JAP_PT984', 'EXT_JAP_PT984', 'EXT_JAP_PT1002', 'EXT_JAP_PT1002', 'EXT_JAP_PT1002', 'EXT_JAP_PT1009', 'EXT_JAP_PT1009', 'EXT_JAP_PT1009', 'EXT_JAP_PT1023', 'EXT_JAP_PT1050', 'EXT_JAP_PT1084', 'EXT_JAP_PT1084', 'EXT_JAP_PT1084', 'EXT_JAP_PT1094', 'EXT_JAP_PT1109', 'EXT_JAP_PT1146', 'EXT_JAP_PT1152', 'EXT_JAP_PT1156', 'EXT_JAP_PT1157', 'EXT_JAP_PT1180', 'EXT_JAP_PT1246', '87960', '95265', '106196', '33254', '33254', '33281', '33281', '33284', '35791', '37796', '49665', '46072', '51980', '51969', '54485', '54604', '54604', '56711', '56711', '57415', '57415', '57415', '57415', '50845', '60702', '60471', '50898', '57183', '56953', '54826', '54830', '46072', '46072', '61982', '61982', '61998', '62000', '62001', '62004', '62007', '62335', '62339', '62344', '62346', '63045', '63631', '64335', '65125', '66654', '66744', '66746', '67330', '66822', '74962', '68540', '68544', '68546', '68547', '68558', '68607', '68891', '73385', '69340', '69801', '66754', '49906', '49906', '71896', '63041', '72903', '73388', '73466', '71246', '73804', '73805', '63138', '65269', '65269', '74116', '74114', '74118', '63225', '57337', '75566', '75567', '67007', '67007', '67007', '60275', '67530', '67524', '67524', '67524', '67524', '63045', '77012', '57326', '54285', '65990', '76294', '80856', '80858', '80860', '80861', '80862', '80863', '80864', '80866', '80868', '80869', '80870', '62524', '62807', '69378', '62631', '71724', '81311', '74436', '74436', '74436', '74436', '74436', '74436', '74436', '74436', '77301', '85152', '85153', '85153', '85154', '74748', '86317', '86318', '80500', '80457', '88550', '71806', '89957', '68758', '91801', '76658', '76611', '96988', '96989', '96991', '96992', '96993', '96994', '96995', '96996', '56544', '53890', 'EXT_WAR_001', 'EXT_WAR_002', 'EXT_WAR_003', 'EXT_WAR_005', 'EXT_WAR_006', 'EXT_WAR_007', 'EXT_WAR_008', 'EXT_WAR_009', 'EXT_WAR_010', 'EXT_WAR_011', '99301', '99302', '99303', '99304', '99305', '99306', '99307', '80859'), "mae_ids" = c('92582-100634R', '89108-101401R', '85030-101676R', 'EXT_JAP_PT1298-102384R', 'EXT_JAP_PT1315-102385R', 'EXT_JAP_PT1320-102386R', 'EXT_JAP_PT1322-102387R', 'EXT_JAP_PT1342-102388R', 'EXT_JAP_PT1396-102389R', 'EXT_JAP_PT1433-102390R', 'EXT_JAP_PT1455-102391R', 'EXT_JAP_PT1475-102392R', 'EXT_JAP_PT322-102393R', 'EXT_JAP_PT1237-102860R', 'EXT_JAP_PT1265-102864R', 'EXT_JAP_PT1278-103174R', 'EXT_JAP_PT1283-102875R', 'EXT_JAP_PT1297-102876R', '55567-102949R', '55563-102950R', '75148-102951R', '55570-102952R', 'EXT_JAP_PT1173-103027R', 'EXT_JAP_PT008-103165R', 'EXT_JAP_PT162-103170R', 'EXT_JAP_PT183-103172R', 'EXT_JAP_PT201-103173R', 'EXT_JAP_PT284-102874R', 'EXT_JAP_PT290-103175R', 'EXT_JAP_PT472-103180R', 'EXT_JAP_PT487-103182R', 'EXT_JAP_PT631-103190R', 'EXT_JAP_PT639-103192R', 'EXT_JAP_PT713-103198R', 'EXT_JAP_PT722-103199R', 'EXT_JAP_PT723-103200R', 'EXT_JAP_PT766-103203R', 'EXT_JAP_PT875-103207R', 'EXT_JAP_PT947-103209R', 'EXT_JAP_PT966-103210R', 'EXT_JAP_PT984-103213R', 'EXT_JAP_PT984-111664R', 'EXT_JAP_PT984-111666R', 'EXT_JAP_PT1002-103214R', 'EXT_JAP_PT1002-111681R', 'EXT_JAP_PT1002-111682R', 'EXT_JAP_PT1009-103216R', 'EXT_JAP_PT1009-111668R', 'EXT_JAP_PT1009-111669R', 'EXT_JAP_PT1023-103217R', 'EXT_JAP_PT1050-103219R', 'EXT_JAP_PT1084-103221R', 'EXT_JAP_PT1084-111670R', 'EXT_JAP_PT1084-111671R', 'EXT_JAP_PT1094-103223R', 'EXT_JAP_PT1109-103225R', 'EXT_JAP_PT1146-103229R', 'EXT_JAP_PT1152-103231R', 'EXT_JAP_PT1156-103230R', 'EXT_JAP_PT1157-103232R', 'EXT_JAP_PT1180-103234R', 'EXT_JAP_PT1246-103239R', '87960-104982R', '95265-105251R', '106196-105896R', '33254-33254R', '33254-MUC1342', '33281-33281R', '33281-MUC1343', '33284-76631', '35791-MUC1344', '37796-MUC1345', '49665-74172', '46072-MUC2202', '51980-76634', '51969-76623', '54485-MUC1347', '54604-77158R', '54604-MUC1348', '56711-MUC1349', '56711-MUC2220', '57415-57415', '57415-70476', '57415-76628', '57415-70478', '50845-76630', '60702-MUC1350', '60471-MUC1351', '50898-76622', '57183-MUC1352', '56953-76626', '54826-76636', '54830-61695', '46072-76624', '46072-MUC1434', '61982-61982', '61982-70479', '61998-MUC1353', '62000-MUC1354', '62001-MUC1355', '62004-MUC1356', '62007-MUC1357', '62335-MUC1358', '62339-MUC1359', '62344-MUC1360', '62346-MUC1361', '63045-MUC1362', '63631-MUC2237', '64335-MUC1363', '65125-MUC1364', '66654-MUC2212', '66744-MUC1365', '66746-MUC1366', '67330-MUC1367', '66822-76627', '74962-MUC1368', '68540-MUC1369', '68544-MUC1370', '68546-MUC1374', '68547-MUC1372', '68558-MUC1373', '68607-MUC1371', '68891-76629', '73385-MUC2232', '69340-MUC1375', '69801-MUC1376', '66754-76625', '49906-76635', '49906-MUC1417', '71896-MUC2215', '63041-72748', '72903-MUC1390', '73388-MUC1391', '73466-MUC1392', '71246-MUC2201', '73804-MUC1396', '73805-MUC1397', '63138-76632', '65269-76633', '65269-MUC1415', '74116-MUC1398', '74114-MUC1399', '74118-MUC1400', '63225-76637', '57337-76638', '75566-MUC1401', '75567-MUC1378', '67007-MUC1379', '67007-MUC1431', '67007-MUC1433', '60275-MUC1380', '67530-MUC1381', '67524-MUC1382', '67524-MUC1437', '67524-MUC1386', '67524-MUC1389', '63045-MUC2210', '77012-MUC1383', '57326-MUC1402', '54285-MUC1403', '65990-MUC1404', '76294-MUC1413', '80856-MUC1414', '80858-MUC1416', '80860-MUC1418', '80861-MUC1419', '80862-MUC1426', '80863-MUC1421', '80864-MUC1422', '80866-MUC1424', '80868-MUC1427', '80869-MUC1420', '80870-MUC1428', '62524-MUC1405', '62807-MUC1406', '69378-MUC1407', '62631-MUC1408', '71724-MUC1409', '81311-MUC2213', '74436-MUC0489', '74436-MUC0490', '74436-MUC0491', '74436-MUC0493', '74436-MUC0494', '74436-MUC0495', '74436-MUC0498', '74436-MUC0499', '77301-MUC2205', '85152-MUC1411', '85153-MUC1384', '85153-MUC1387', '85154-MUC1412', '74748-MUC2204', '86317-MUC2211', '86318-MUC2209', '80500-MUC2219', '80457-MUC2203', '88550-MUC2222', '71806-MUC1435', '89957-MUC2207', '68758-MUC2208', '91801-MUC2223', '76658-MUC2216', '76611-MUC2217', '96988-MUC2225', '96989-MUC2224', '96991-MUC2227', '96992-MUC2226', '96993-MUC2229', '96994-MUC2228', '96995-MUC2231', '96996-MUC2230', '56544-97810R', '53890-98521R', 'EXT_WAR_001-99291R', 'EXT_WAR_002-99292R', 'EXT_WAR_003-99293R', 'EXT_WAR_005-99294R', 'EXT_WAR_006-99295R', 'EXT_WAR_007-99296R', 'EXT_WAR_008-99297R', 'EXT_WAR_009-99298R', 'EXT_WAR_010-99299R', 'EXT_WAR_011-99300R', '99301-99301R', '99302-99302R', '99303-99303R', '99304-99304R', '99305-99305R', '99306-99306R', '99307-99307R', '80859-MUC1425'), "INTER_FEATURE" = c(0), "rawdir_proteome" = '/s/project/mitoMultiOmics/raw_data/proteome', "PROC_DATA" = '/s/project/genetic_diagnosis/processed_data'),
    rule = 'Scripts_Aberrant_Expression_Counting_count_ranges_R'
)
######## Original script #########
#'---
#' title: Create count Granges from annotation
#' author: mumichae, vyepez
#' wb:
#'  input:
#'   - gtex_txdb: '`sm config["PROC_RESULTS"] + "/v19/txdb.db"`'
#'   - gencode_txdb: '`sm config["PROC_RESULTS"] + "/v29/txdb.db"`'
#'  output:
#'   - gtex_op: '`sm config["PROC_RESULTS"] + "/v19/counts/exons_by_gene_op.Rds"`'
#'   - gencode_op: '`sm config["PROC_RESULTS"] + "/v29/counts/exons_by_gene_op.Rds"`'
#'   - gencode_ov_op: '`sm config["PROC_RESULTS"] + "/v29_overlap/counts/exons_by_gene_op.Rds"`'
#'  type: script
#'---

#TODO: change name of output files for later input! rds vs. Rds

saveRDS(snakemake,  "tmp/count_ranges.snakemake")
# snakemake <- readRDS("tmp/count_ranges.snakemake")
suppressPackageStartupMessages({
    library(GenomicFeatures)
    library(GenomicRanges)
})

gtex_txdb <- loadDb(snakemake@input$gtex_txdb)
seqlevelsStyle(gtex_txdb) <- "UCSC"
gencode_txdb <- loadDb(snakemake@input$gencode_txdb)
gencode_txdb <- keepStandardChromosomes(gencode_txdb)

invert_strand <- function(exons) {
    exons_op <- data.table::copy(exons)
    if (class(exons) == "GRanges") {
        strand(exons_op) <- ifelse(strand(exons) == '+', '-', '+')
    } else if (class(exons) %in% c("GRangesList", "CompressedGRangesList")) {
        unlisted <- unlist(exons_op) # create genomic ranges object
        strand(unlisted) <- ifelse(strand(unlisted) == '+', '-', '+')
        exons_op <- relist(unlisted, exons_op) # change back to GRList
    } else {
        message(class(exons))
    }
    exons_op
}

# gtex gencode 19
gtex_op <- invert_strand(exonsBy(gtex_txdb, by = "gene"))
saveRDS(gtex_op, snakemake@output$gtex_op)

# gencode 29
gencode_op <- invert_strand(exonsBy(gencode_txdb, by = "gene"))
saveRDS(gencode_op, snakemake@output$gencode_op)
saveRDS(gencode_op, snakemake@output$gencode_ov_op)

